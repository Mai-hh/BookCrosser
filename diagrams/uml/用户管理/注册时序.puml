@startuml
actor User
participant MainActivity
participant SignUpScreen
participant SignUpViewModel
participant AuthRepository
participant AuthUtil
participant UserRepository
participant JWTService

User -> MainActivity: 进入注册页面
MainActivity -> SignUpScreen: 显示注册表单

User -> SignUpScreen: 填写注册信息
User -> SignUpScreen: 提交注册表单

SignUpScreen -> SignUpViewModel: submitRegistration()

SignUpViewModel -> SignUpViewModel: 校验表单数据
alt 表单数据无效
   SignUpViewModel -> SignUpScreen: 返回表单验证错误
   SignUpScreen -> User: 显示错误提示
else 表单数据有效
   SignUpViewModel -> AuthRepository: register()

   AuthRepository -> UserRepository: findByUsername()
   UserRepository -> AuthRepository: 返回查询结果

   AuthRepository -> UserRepository: findByEmail()
   UserRepository -> AuthRepository: 返回查询结果

   alt 用户名或邮箱已存在
       AuthRepository -> SignUpViewModel: 返回用户已存在错误
       SignUpViewModel -> SignUpScreen: 显示错误提示
       SignUpScreen -> User: 显示错误提示
   else 用户名和邮箱未被注册
       AuthRepository -> AuthUtil: sendVerificationEmail()
       AuthUtil -> AuthRepository: 返回邮件发送结果

       AuthRepository -> UserRepository: save()
       UserRepository -> AuthRepository: 返回保存结果

       AuthRepository -> JWTService: generateToken()
       JWTService -> AuthRepository: 返回生成的JWT

       AuthRepository -> SignUpViewModel: 返回注册成功和JWT
       SignUpViewModel -> SignUpScreen: 显示注册成功提示
       SignUpScreen -> User: 显示注册成功提示
   end
end

User -> SignUpScreen: 点击登录按钮
SignUpScreen -> SignUpViewModel: login()

SignUpViewModel -> AuthRepository: login()
AuthRepository -> JWTService: validateToken()

alt JWT有效
   JWTService -> AuthRepository: 返回解析后的用户信息
   AuthRepository -> SignUpViewModel: 返回登录成功
   SignUpViewModel -> SignUpScreen: 跳转到主页面
else JWT无效
   JWTService -> AuthRepository: 返回JWT无效错误
   AuthRepository -> SignUpViewModel: 返回登录失败
   SignUpViewModel -> SignUpScreen: 显示登录失败提示
end
@enduml